{% extends 'base.html' %}

{% block title %}Seva Booking - Raghavendra Swami Math{% endblock %}

{% block content %}
<div id="rsm-booking-container">
    <div id="rsm-booking-header-section">
        <div id="rsm-booking-header-row">
            <div id="rsm-booking-header-column">
                <h1 id="rsm-booking-header-heading">Seva Booking</h1>
                <div id="rsm-booking-header-divider">
                    <div id="rsm-booking-header-divider-line"></div>
                    <div id="rsm-booking-header-divider-icon">ॐ</div>
                    <div id="rsm-booking-header-divider-line"></div>
                </div>
                <p id="rsm-booking-header-text">Book your sevas at Raghavendra Swami Math, Chhatrapati Sambhaji Nagar.
                </p>
            </div>
        </div>
    </div>

    <!-- Available Sevas Section -->
    <!-- Available Sevas Section -->
    <div id="rsm-booking-sevas-section">
        <div id="rsm-booking-sevas-row">
            <div id="rsm-booking-sevas-column">
                <div id="rsm-booking-sevas-card">
                    <div id="rsm-booking-sevas-card-header">
                        <h3 id="rsm-booking-sevas-card-title">Available Sevas</h3>
                    </div>
                    <div id="rsm-booking-sevas-card-body">
                        <div id="rsm-booking-sevas-table-container">
                            <!-- Daily Activities -->
                            <div class="rsm-booking-seva-category">
                                <div class="rsm-booking-category-header" onclick="toggleCategory(this)">
                                    <h2 class="rsm-booking-category-title">दैनंदिनी</h2>
                                    <span class="rsm-booking-category-toggle">+</span>
                                </div>
                                <div class="rsm-booking-category-content">
                                    <!-- Shraadh -->
                                    <div class="rsm-booking-seva-item">
                                        <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                            <div id="rsm-booking-sevas-cell-name-shraadh" class="rsm-booking-seva-name">
                                                श्राद्ध</div>
                                            <span class="rsm-booking-seva-toggle">+</span>
                                        </div>
                                        <div class="rsm-booking-seva-details">
                                            <div id="rsm-booking-sevas-cell-description-shraadh"
                                                class="rsm-booking-seva-description">दरोज</div>
                                            <div id="rsm-booking-sevas-cell-contribution-shraadh"
                                                class="rsm-booking-seva-contribution">₹ १२००/- दोन व्यक्ती. अधिक व्यक्ती
                                                साठी ₹ २००/व्यक्ती.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Weekly Activities -->
                            <div class="rsm-booking-seva-category">
                                <div class="rsm-booking-category-header" onclick="toggleCategory(this)">
                                    <h2 class="rsm-booking-category-title">साप्ताहिक</h2>
                                    <span class="rsm-booking-category-toggle">+</span>
                                </div>
                                <div class="rsm-booking-category-content">
                                    <!-- Ashtottar -->
                                    <div class="rsm-booking-seva-item">
                                        <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                            <div id="rsm-booking-sevas-cell-name-ashtottar"
                                                class="rsm-booking-seva-name">अष्टोत्तर</div>
                                            <span class="rsm-booking-seva-toggle">+</span>
                                        </div>
                                        <div class="rsm-booking-seva-details">
                                            <div id="rsm-booking-sevas-cell-description-ashtottar"
                                                class="rsm-booking-seva-description">दर गुरुवारी</div>
                                            <div id="rsm-booking-sevas-cell-contribution-ashtottar"
                                                class="rsm-booking-seva-contribution">स्वइच्छा</div>
                                        </div>
                                    </div>

                                    <!-- Palakhi -->
                                    <div class="rsm-booking-seva-item">
                                        <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                            <div id="rsm-booking-sevas-cell-name-palakhi" class="rsm-booking-seva-name">
                                                पालखी</div>
                                            <span class="rsm-booking-seva-toggle">+</span>
                                        </div>
                                        <div class="rsm-booking-seva-details">
                                            <div id="rsm-booking-sevas-cell-description-palakhi"
                                                class="rsm-booking-seva-description">दर गुरुवारी</div>
                                            <div id="rsm-booking-sevas-cell-contribution-palakhi"
                                                class="rsm-booking-seva-contribution">स्वइच्छा</div>
                                        </div>
                                    </div>

                                    <!-- Annadan -->
                                    <div class="rsm-booking-seva-item">
                                        <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                            <div id="rsm-booking-sevas-cell-name-annadan" class="rsm-booking-seva-name">
                                                अन्नदान</div>
                                            <span class="rsm-booking-seva-toggle">+</span>
                                        </div>
                                        <div class="rsm-booking-seva-details">
                                            <div id="rsm-booking-sevas-cell-description-annadan"
                                                class="rsm-booking-seva-description">दर गुरुवारी</div>
                                            <div id="rsm-booking-sevas-cell-contribution-annadan"
                                                class="rsm-booking-seva-contribution">स्वइच्छा</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Monthly Activities -->
                            <div class="rsm-booking-seva-category">
                                <div class="rsm-booking-category-header" onclick="toggleCategory(this)">
                                    <h2 class="rsm-booking-category-title">मासिक</h2>
                                    <span class="rsm-booking-category-toggle">+</span>
                                </div>
                                <div class="rsm-booking-category-content">
                                    <!-- Satyanarayan Puja -->
                                    <div class="rsm-booking-seva-item">
                                        <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                            <div id="rsm-booking-sevas-cell-name-satyanarayan"
                                                class="rsm-booking-seva-name">सत्यनारायण पूजा</div>
                                            <span class="rsm-booking-seva-toggle">+</span>
                                        </div>
                                        <div class="rsm-booking-seva-details">
                                            <div id="rsm-booking-sevas-cell-description-satyanarayan"
                                                class="rsm-booking-seva-description">प्रत्येक पोर्णिमा</div>
                                            <div id="rsm-booking-sevas-cell-contribution-satyanarayan"
                                                class="rsm-booking-seva-contribution">₹ ५०१/</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Yearly Activities -->
                            <div class="rsm-booking-seva-category">
                                <div class="rsm-booking-category-header" onclick="toggleCategory(this)">
                                    <h2 class="rsm-booking-category-title">वार्षिक</h2>
                                    <span class="rsm-booking-category-toggle">+</span>
                                </div>
                                <div class="rsm-booking-category-content">
                                    <!-- Paksh -->
                                    <div class="rsm-booking-seva-item">
                                        <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                            <div id="rsm-booking-sevas-cell-name-paksh" class="rsm-booking-seva-name">
                                                पक्षपंधरवडा</div>
                                            <span class="rsm-booking-seva-toggle">+</span>
                                        </div>
                                        <div class="rsm-booking-seva-details">
                                            <div id="rsm-booking-sevas-cell-description-paksh"
                                                class="rsm-booking-seva-description">पक्षपंधरवडा</div>
                                            <div id="rsm-booking-sevas-cell-contribution-paksh"
                                                class="rsm-booking-seva-contribution">₹ १२००/- दोन व्यक्ती.</div>
                                        </div>
                                    </div>

                                    <!-- Utsav -->
                                    <div class="rsm-booking-seva-item">
                                        <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                            <div id="rsm-booking-sevas-cell-name-utsav" class="rsm-booking-seva-name">
                                                उत्सव</div>
                                            <span class="rsm-booking-seva-toggle">+</span>
                                        </div>
                                        <div class="rsm-booking-seva-details">
                                            <!-- Ashtottar -->
                                            <div class="rsm-booking-seva-item">
                                                <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                                    <div id="rsm-booking-sevas-cell-name-utsav-ashtottar"
                                                        class="rsm-booking-seva-name">अष्टोत्तर</div>
                                                    <span class="rsm-booking-seva-toggle">+</span>
                                                </div>
                                                <div class="rsm-booking-seva-details">
                                                    <div id="rsm-booking-sevas-cell-description-utsav-ashtottar"
                                                        class="rsm-booking-seva-description">दर गुरुवारी</div>
                                                    <div id="rsm-booking-sevas-cell-contribution-utsav-ashtottar"
                                                        class="rsm-booking-seva-contribution">स्वइच्छा</div>
                                                </div>
                                            </div>

                                            <!-- Palakhi -->
                                            <div class="rsm-booking-seva-item">
                                                <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                                    <div id="rsm-booking-sevas-cell-name-utsav-palakhi"
                                                        class="rsm-booking-seva-name">
                                                        पालखी</div>
                                                    <span class="rsm-booking-seva-toggle">+</span>
                                                </div>
                                                <div class="rsm-booking-seva-details">
                                                    <div id="rsm-booking-sevas-cell-description-utsav-palakhi"
                                                        class="rsm-booking-seva-description">दर गुरुवारी</div>
                                                    <div id="rsm-booking-sevas-cell-contribution-utsav-palakhi"
                                                        class="rsm-booking-seva-contribution">स्वइच्छा</div>
                                                </div>
                                            </div>

                                            <!-- Annadan -->
                                            <div class="rsm-booking-seva-item">
                                                <div class="rsm-booking-seva-header" onclick="toggleSeva(this)">
                                                    <div id="rsm-booking-sevas-cell-name-utsav-annadan"
                                                        class="rsm-booking-seva-name">
                                                        अन्नदान</div>
                                                    <span class="rsm-booking-seva-toggle">+</span>
                                                </div>
                                                <div class="rsm-booking-seva-details">
                                                    <div id="rsm-booking-sevas-cell-description-utsav-annadan"
                                                        class="rsm-booking-seva-description">दर गुरुवारी</div>
                                                    <div id="rsm-booking-sevas-cell-contribution-utsav-annadan"
                                                        class="rsm-booking-seva-contribution">स्वइच्छा</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="rsm-booking-sevas-info">
                            <p id="rsm-booking-sevas-info-text">Dates are subject to availability. Please book at least
                                3 days in advance.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Form Section -->
    <div id="rsm-booking-form-section">
        <div id="rsm-booking-form-row">
            <div id="rsm-booking-form-column">
                <div id="rsm-booking-form-card">
                    <div id="rsm-booking-form-card-header">
                        <h3 id="rsm-booking-form-card-title">Book Your Seva</h3>
                    </div>
                    <div id="rsm-booking-form-card-body">
                        <form action="{{ url_for('seva.book_seva') }}" method="POST" id="rsm-booking-form">
                            <div id="rsm-booking-form-row-1">
                                <div id="rsm-booking-form-column-1">
                                    <label for="rsm-booking-form-name" id="rsm-booking-form-label-name">Full
                                        Name*</label>
                                    <input type="text" id="rsm-booking-form-name" name="name" required>
                                </div>
                                <div id="rsm-booking-form-column-2">
                                    <label for="rsm-booking-form-email" id="rsm-booking-form-label-email">Email
                                        Address*</label>
                                    <input type="email" id="rsm-booking-form-email" name="email" required>
                                </div>
                            </div>

                            <div id="rsm-booking-form-row-2">
                                <div id="rsm-booking-form-column-1">
                                    <label for="rsm-booking-form-phone" id="rsm-booking-form-label-phone">Phone
                                        Number*</label>
                                    <input type="tel" id="rsm-booking-form-phone" name="phone" required>
                                </div>
                                <div id="rsm-booking-form-column-2">
                                    <label for="rsm-booking-form-gothra"
                                        id="rsm-booking-form-label-gothra">Gothra</label>
                                    <input type="text" id="rsm-booking-form-gothra" name="gothra">
                                </div>
                            </div>

                            <div id="rsm-booking-form-row-3">
                                <div id="rsm-booking-form-column-1">
                                    <label for="rsm-booking-form-sevaType" id="rsm-booking-form-label-sevaType">Select
                                        Seva*</label>
                                    <select id="rsm-booking-form-sevaType" name="sevaType" required
                                        onchange="toggleTimeSlot()">
                                        <option value="">Choose Seva...</option>
                                        <option value="Abhishekam">अष्टोत्तर (स्वैच्छिक)</option>
                                        <option value="Archana">पालखी (स्वैच्छिक)</option>
                                        <option value="Sahasranama Archana">अन्नदान (स्वैच्छिक)</option>
                                        <option value="Shradha">श्राद्ध ₹ १२००/- दोन व्यक्ती अधिक व्यक्ती साठी ₹
                                            २००/व्यक्ती.</option>
                                        <option value="Pakshapandharwada">पक्षपंधरवाडा ₹ १२००/- दोन व्यक्ती</option>
                                        <option value="Annadhanam">सत्यनारायण पूजा ₹ ५०१/-</option>
                                    </select>
                                </div>
                                <div id="rsm-booking-form-column-2">
                                    <label for="rsm-booking-form-sevaDate"
                                        id="rsm-booking-form-label-sevaDate">Preferred Date*</label>
                                    <input type="date" id="rsm-booking-form-sevaDate" name="sevaDate" required>
                                </div>
                            </div>

                            <div id="rsm-booking-form-row-time">
                                <label for="rsm-booking-form-sevaTime" id="rsm-booking-form-label-sevaTime">Preferred
                                    Time*</label>
                                <select id="rsm-booking-form-sevaTime" name="sevaTime" required>
                                    <option value="">Select Time...</option>
                                    <option value="07:00">07:00 AM</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                </select>
                                <!-- Hidden default time input that will be used when time slot is not visible -->
                                <input type="hidden" id="rsm-booking-form-sevaTime-default" name="sevaTimeDefault"
                                    value="00:00">
                            </div>

                            <!-- Availability Section -->
                            <div id="rsm-booking-availability-section" style="display: none;">
                                <div id="rsm-booking-availability-row">
                                    <div id="rsm-booking-availability-column">
                                        <div id="rsm-booking-availability-card">
                                            <div id="rsm-booking-availability-card-header">
                                                <h3 id="rsm-booking-availability-card-title">Available Slots</h3>
                                            </div>
                                            <div id="rsm-booking-availability-card-body">
                                                <div id="rsm-booking-availability-info">
                                                    <p id="rsm-booking-availability-text"><span
                                                            id="rsm-booking-availability-count">60/60</span> slots
                                                        available for <span id="rsm-booking-selected-seva"></span> on
                                                        <span id="rsm-booking-selected-date"></span> at <span
                                                            id="rsm-booking-selected-time"></span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="rsm-booking-form-row-4">
                                <label for="rsm-booking-form-nakshatra" id="rsm-booking-form-label-nakshatra">Star
                                    (Nakshatra)</label>
                                <select id="rsm-booking-form-nakshatra" name="nakshatra">
                                    <option value="">Select Nakshatra (Optional)</option>
                                    <option value="Ashwini">Ashwini</option>
                                    <option value="Bharani">Bharani</option>
                                    <option value="Krittika">Krittika</option>
                                    <option value="Rohini">Rohini</option>
                                    <option value="Mrigashira">Mrigashira</option>
                                    <option value="Ardra">Ardra</option>
                                    <option value="Punarvasu">Punarvasu</option>
                                    <option value="Pushya">Pushya</option>
                                    <option value="Ashlesha">Ashlesha</option>
                                    <option value="Magha">Magha</option>
                                    <option value="Purva Phalguni">Purva Phalguni</option>
                                    <option value="Uttara Phalguni">Uttara Phalguni</option>
                                    <option value="Hasta">Hasta</option>
                                    <option value="Chitra">Chitra</option>
                                    <option value="Swati">Swati</option>
                                    <option value="Vishakha">Vishakha</option>
                                    <option value="Anuradha">Anuradha</option>
                                    <option value="Jyeshtha">Jyeshtha</option>
                                    <option value="Mula">Mula</option>
                                    <option value="Purva Ashadha">Purva Ashadha</option>
                                    <option value="Uttara Ashadha">Uttara Ashadha</option>
                                    <option value="Shravana">Shravana</option>
                                    <option value="Dhanishta">Dhanishta</option>
                                    <option value="Shatabhisha">Shatabhisha</option>
                                    <option value="Purva Bhadrapada">Purva Bhadrapada</option>
                                    <option value="Uttara Bhadrapada">Uttara Bhadrapada</option>
                                    <option value="Revati">Revati</option>
                                </select>
                            </div>

                            <div id="rsm-booking-form-row-5">
                                <label for="rsm-booking-form-message" id="rsm-booking-form-label-message">Special
                                    Instructions (Optional)</label>
                                <textarea id="rsm-booking-form-message" name="message" rows="3"></textarea>
                            </div>

                            <div id="rsm-booking-form-row-6">
                                <label id="rsm-booking-form-label-family">Family Members (For whom the Seva is being
                                    performed)</label>
                                <div id="rsm-booking-form-family-container">
                                    <div id="rsm-booking-form-family-row-1">
                                        <div id="rsm-booking-form-family-column-1">
                                            <input type="text" id="rsm-booking-form-family-name-1" name="familyName[]"
                                                placeholder="Name">
                                        </div>
                                        <div id="rsm-booking-form-family-column-2">
                                            <input type="text" id="rsm-booking-form-family-relation-1"
                                                name="familyRelation[]" placeholder="Relation">
                                        </div>
                                        <div id="rsm-booking-form-family-column-3">
                                            <button type="button" id="rsm-booking-form-family-add"
                                                class="rsm-booking-form-family-add">Add</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="rsm-booking-form-row-7">
                                <input type="checkbox" id="rsm-booking-form-terms" required>
                                <label for="rsm-booking-form-terms" id="rsm-booking-form-label-terms">I agree to the
                                    terms and conditions</label>
                            </div>

                            <div id="rsm-booking-form-row-8">
                                <p id="rsm-booking-form-payment-method">Payment Method:</p>
                                <div id="rsm-booking-form-payment-online">
                                    <input type="radio" id="rsm-booking-form-pay-online" name="paymentMethod"
                                        value="online" checked>
                                    <label for="rsm-booking-form-pay-online">Pay Online</label>
                                </div>
                                <div id="rsm-booking-form-payment-math">
                                    <input type="radio" id="rsm-booking-form-pay-math" name="paymentMethod"
                                        value="math">
                                    <label for="rsm-booking-form-pay-math">Pay at Math</label>
                                </div>
                            </div>

                            <div id="rsm-booking-form-submit">
                                <button type="submit" id="rsm-booking-form-submit-button">Book Seva</button>
                            </div>
                        </form>
                    </div>

                    <script>
                        // Function to toggle time slot visibility based on selected seva type
                        // Function to toggle date selection based on selected seva type
                        // Function to toggle date selection based on selected seva type
                        function toggleDateSelection() {
                            const sevaType = document.getElementById('rsm-booking-form-sevaType').value;
                            const dateInput = document.getElementById('rsm-booking-form-sevaDate');
                            const timeSelect = document.getElementById('rsm-booking-form-sevaTime');
                            const dateInputContainer = dateInput.parentElement;

                            // If Pakshapandharwada is selected, replace date input with custom dropdown
                            if (sevaType === 'Pakshapandharwada') {
                                // Completely hide the default date input
                                dateInput.style.display = 'none';

                                // Remove existing dropdown if present to avoid duplicates
                                const existingSelect = document.getElementById('paksha-date-select');
                                if (existingSelect) {
                                    existingSelect.remove();
                                }

                                // Create new custom date selection dropdown
                                const pakshaDates = document.createElement('select');
                                pakshaDates.id = 'paksha-date-select';
                                pakshaDates.name = 'paksha-date-select';
                                pakshaDates.required = true;
                                // Copy styling from the original date input to maintain form appearance
                                pakshaDates.style.width = '100%';
                                pakshaDates.style.padding = '8px';
                                pakshaDates.style.borderRadius = '4px';
                                pakshaDates.style.border = '1px solid #ccc';

                                // Add the dates as options with tithi information
                                const dates = [
                                    { date: '2025-09-08', tithi: 'प्रतिपदा' },
                                    { date: '2025-09-09', tithi: 'द्वितीया' },
                                    { date: '2025-09-10', tithi: 'तृतीया' },
                                    { date: '2025-09-11', tithi: 'चतुर्थी' },
                                    { date: '2025-09-12', tithi: 'पंचमी व षष्टी' },
                                    { date: '2025-09-13', tithi: 'सप्तमी' },
                                    { date: '2025-09-14', tithi: 'अष्टमी' },
                                    { date: '2025-09-15', tithi: 'नवमी' },
                                    { date: '2025-09-16', tithi: 'दशमी' },
                                    // No 17-09 as per requirement
                                    { date: '2025-09-18', tithi: 'एकादशी व द्वादशी' },
                                    { date: '2025-09-19', tithi: 'त्रयोदशी' },
                                    { date: '2025-09-20', tithi: 'चतुर्दशी' },
                                    { date: '2025-09-21', tithi: 'अमावस्या' }
                                ];

                                // Add a default empty option
                                const defaultOption = document.createElement('option');
                                defaultOption.value = '';
                                defaultOption.textContent = 'तारीख निवडा';
                                pakshaDates.appendChild(defaultOption);

                                // Add all date options with the exact format you want
                                dates.forEach(item => {
                                    const option = document.createElement('option');
                                    option.value = item.date;

                                    // Format date exactly as requested: DD-MM-YY without leading zeros
                                    const date = new Date(item.date);
                                    const day = date.getDate();
                                    const month = date.getMonth() + 1;

                                    option.textContent = `${day}-${month}-25 ${item.tithi}`;
                                    pakshaDates.appendChild(option);
                                });

                                // Insert the custom select after the date input
                                dateInputContainer.appendChild(pakshaDates);

                                // Event listener for the custom date select
                                pakshaDates.addEventListener('change', function () {
                                    // Set the actual date input value to maintain database compatibility
                                    dateInput.value = this.value;

                                    // Update time slots based on selected date
                                    updateTimeSlots(this.value);

                                    // Trigger change event on date input for availability check
                                    const event = new Event('change');
                                    dateInput.dispatchEvent(event);
                                });
                            } else {
                                // For other seva types, show default date picker
                                dateInput.style.display = 'block';

                                // Remove custom date select if it exists
                                const pakshaDates = document.getElementById('paksha-date-select');
                                if (pakshaDates) {
                                    pakshaDates.remove();
                                }
                            }
                        }

                        // Function to update time slots based on selected date
                        function updateTimeSlots(selectedDate) {
                            const timeSelect = document.getElementById('rsm-booking-form-sevaTime');

                            // Clear existing options
                            while (timeSelect.options.length > 1) {
                                timeSelect.remove(1);
                            }

                            // Default option
                            timeSelect.options[0].text = 'Select Time...';

                            // Special dates with 7, 9, and 11 AM slots (12th, 18th and 21st)
                            if (['2025-09-12', '2025-09-18', '2025-09-21'].includes(selectedDate)) {
                                addTimeOption(timeSelect, '07:00', '07:00 AM');
                                addTimeOption(timeSelect, '09:00', '09:00 AM');
                                addTimeOption(timeSelect, '11:00', '11:00 AM');
                            }
                            // All other dates have only 9 and 11 AM slots
                            else {
                                addTimeOption(timeSelect, '09:00', '09:00 AM');
                                addTimeOption(timeSelect, '11:00', '11:00 AM');
                            }
                        }

                        // Helper function to add time options
                        function addTimeOption(selectElement, value, text) {
                            const option = document.createElement('option');
                            option.value = value;
                            option.textContent = text;
                            selectElement.appendChild(option);
                        }

                        // Modify the existing toggleTimeSlot function to call our new function
                        function toggleTimeSlot() {
                            const sevaType = document.getElementById('rsm-booking-form-sevaType').value;
                            const timeRow = document.getElementById('rsm-booking-form-row-time');
                            const timeSelect = document.getElementById('rsm-booking-form-sevaTime');
                            const defaultTimeInput = document.getElementById('rsm-booking-form-sevaTime-default');

                            // Show time slot for Shradha or Pakshapandharwada
                            if (sevaType === 'Pakshapandharwada') {
                                timeRow.style.display = 'block';
                                timeSelect.required = true;
                                defaultTimeInput.disabled = true;
                            } else {
                                timeRow.style.display = 'none';
                                timeSelect.required = false;
                                timeSelect.value = '';
                                defaultTimeInput.disabled = false;
                            }

                            // Call our date selection function
                            toggleDateSelection();
                        }

                        // Initialize the form state on page load
                        document.addEventListener('DOMContentLoaded', function () {
                            // Hide time slot by default
                            document.getElementById('rsm-booking-form-row-time').style.display = 'none';

                            // Set up the form with proper initial state
                            toggleTimeSlot();

                            // Listen for changes to the seva type
                            document.getElementById('rsm-booking-form-sevaType').addEventListener('change', toggleTimeSlot);

                            // Handle form submission
                            document.getElementById('rsm-booking-form').addEventListener('submit', function (event) {
                                const sevaType = document.getElementById('rsm-booking-form-sevaType').value;
                                const timeSelect = document.getElementById('rsm-booking-form-sevaTime');
                                const defaultTimeInput = document.getElementById('rsm-booking-form-sevaTime-default');
                                const dateInput = document.getElementById('rsm-booking-form-sevaDate');

                                // If time slot is not visible, use the default time value
                                if (sevaType !== 'Shradha' && sevaType !== 'Pakshapandharwada') {
                                    timeSelect.value = defaultTimeInput.value;
                                }

                                // For Pakshapandharwada, make sure the date value from custom select is transferred to the original input
                                if (sevaType === 'Pakshapandharwada') {
                                    const pakshaDates = document.getElementById('paksha-date-select');
                                    if (pakshaDates && pakshaDates.value) {
                                        dateInput.value = pakshaDates.value;
                                    } else {
                                        // Prevent submission if no date is selected
                                        event.preventDefault();
                                        alert('Please select a date for Pakshapandharwada');
                                    }
                                }
                            });
                        });
                    </script>


                    <div id="rsm-booking-info-card">
                        <div id="rsm-booking-info-card-body">
                            <h4 id="rsm-booking-info-title">कृपया लक्ष्यात घ्यावे </h4>
                            <ul id="rsm-booking-info-list">
                                <li id="rsm-booking-info-item-1">सेवा नोंदणी नंतर संदेश येईल </li>
                                <li id="rsm-booking-info-item-2">ठरलेल्या वेळेच्या 30 मि.आधी यावे </li>
                                <li id="rsm-booking-info-item-3">नोंद झालेली सेवा रद्द केली जाणार नाही </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- JavaScript for Adding More Family Members and Checking Availability -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Family members functionality
        const container = document.getElementById('rsm-booking-form-family-container');

        document.querySelector('.rsm-booking-form-family-add').addEventListener('click', function () {
            const newRow = document.createElement('div');
            newRow.className = 'rsm-booking-form-family-row';
            newRow.innerHTML = `
            <div class="rsm-booking-form-family-column-1">
                <input type="text" name="familyName[]" placeholder="Name">
            </div>
            <div class="rsm-booking-form-family-column-2">
                <input type="text" name="familyRelation[]" placeholder="Relation">
            </div>
            <div class="rsm-booking-form-family-column-3">
                <button type="button" class="rsm-booking-form-family-remove">Remove</button>
            </div>
        `;
            container.appendChild(newRow);

            // Add event listener to the new remove button
            newRow.querySelector('.rsm-booking-form-family-remove').addEventListener('click', function () {
                container.removeChild(newRow);
            });
        });

        // Availability checking functionality
        const sevaSelect = document.getElementById('rsm-booking-form-sevaType');
        const dateInput = document.getElementById('rsm-booking-form-sevaDate');
        const timeSelect = document.getElementById('rsm-booking-form-sevaTime');
        const availabilitySection = document.getElementById('rsm-booking-availability-section');
        const selectedSevaElem = document.getElementById('rsm-booking-selected-seva');
        const selectedDateElem = document.getElementById('rsm-booking-selected-date');
        const selectedTimeElem = document.getElementById('rsm-booking-selected-time');
        const availabilityCountElem = document.getElementById('rsm-booking-availability-count');

        function checkAvailability() {
            const seva = sevaSelect.value;
            const date = dateInput.value;
            const time = timeSelect.value;

            if (seva && date && time) {
                // Format the date for display
                const formattedDate = new Date(date).toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                // Format the time for display (convert 24h to 12h format with AM/PM)
                let formattedTime;
                if (time.includes('AM') || time.includes('PM')) {
                    formattedTime = time; // Already in 12-hour format
                } else {
                    // Convert 24-hour format to 12-hour format
                    const timeHour = parseInt(time.split(':')[0]);
                    formattedTime = (timeHour > 12 ? timeHour - 12 : timeHour) + ':00 ' + (timeHour >= 12 ? 'PM' : 'AM');
                }

                // Update the availability section
                selectedSevaElem.textContent = seva;
                selectedDateElem.textContent = formattedDate;
                selectedTimeElem.textContent = formattedTime;

                // Show loading state
                availabilityCountElem.textContent = 'Checking...';
                availabilitySection.style.display = 'block';

                // Fetch real-time availability from the server - with cache busting to prevent stale data
                fetch('/seva/check-availability?cacheBust=' + new Date().getTime(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sevaType: seva,
                        sevaDate: date,
                        sevaTime: time
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            console.error('Error checking availability:', data.error);
                            availabilityCountElem.textContent = 'Error checking availability';
                        } else {
                            availabilityCountElem.textContent = data.available_slots + '/' + data.total_slots;

                            // Disable submit button if no slots available
                            const submitButton = document.getElementById('rsm-booking-form-submit-button');
                            if (data.available_slots <= 0) {
                                submitButton.disabled = true;
                                submitButton.textContent = 'No Slots Available';
                            } else {
                                submitButton.disabled = false;
                                submitButton.textContent = 'Book Seva';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        availabilityCountElem.textContent = 'Error checking availability';
                    });
            } else {
                availabilitySection.style.display = 'none';
            }
        }

        sevaSelect.addEventListener('change', checkAvailability);
        dateInput.addEventListener('change', checkAvailability);
        timeSelect.addEventListener('change', checkAvailability);

        // Set minimum date to today
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayString = `${yyyy}-${mm}-${dd}`;
        dateInput.min = todayString;

        // Add event listener for form submission to refresh availability after successful booking
        const bookingForm = document.getElementById('rsm-booking-form');
        if (bookingForm) {
            bookingForm.addEventListener('submit', function () {
                // Check availability again after a short delay
                setTimeout(checkAvailability, 3000);
            });
        }
    });
</script>
{% endblock %}